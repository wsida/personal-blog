---
layout: doc
navbar: true
sidebar: false
prev: false
next: false
title: note
noteTime: 2025/06/11
noteTitle: 微信小程序Map组件开发入坑
noteSummary: 在微信小程序中使用Map组件遇到的坑，再此记录以防再次踩坑
---

<!--@include: ../../.vitepress/parts/note-child.md-->

# 微信小程序Map组件开发入坑

## 兼容概览

| 功能点\设备 | ios | android/ohos | mac | window | devtool |
| :-- | :-- | :-- | :-- | :-- | :-- |
| marker点击事件 | ✅正常 | ✅正常 | ⚠️PC端点击marker图标，事件冒泡会同时触发map点击，容易引起气泡自动关闭（点击marker打开气泡，点击map关闭气泡）| ⚠️同mac | ⚠️同mac |
| marker label 点击事件 | ✅正常 | ✅正常 | ✅正常 | ✅正常 | ✅正常 |
| marker label 默认展示偏移差异 | 默认居中，x方向不需要偏移 | 默认label左上角在定位点，x方向需要偏移 |  默认居中，x方向不需要偏移 | 默认居中，x方向不需要偏移 | 默认居中，x方向不需要偏移 |
| 双指缩放触发区域变化事件 | ✅正常 | ✅正常 | ⚠️PC无法在缩放情况下触发区域变化，需要单独监听滚动wheel事件 | ⚠️同mac | ⚠️同mac |
| marker层级问题 | ✅正常 | ✅正常 | ⚠️PC端层级设置异常，绿色marker层级失效，无法覆盖普通marker | ⚠️同mac | ⚠️同mac |
| 点击自定义聚合点 | ❌无法触发点击事件 | ✅正常 | ✅正常 | ✅正常 | ✅正常 |
| 点击默认聚合点 | ❌无法触发点击事件 | ❌无法触发点击事件 | ❌无法触发点击事件 | ❌无法触发点击事件 | ❌无法触发点击事件 |
| 聚合点变化事件 | ⚠️3.4.3及以上支持 | ⚠️3.4.3及以上支持 | ❌无法触发事件 | ❌无法触发事件 | ❌无法触发事件 |

## 功能影响

| 功能点 | 影响 | 解决 |
| :-- | :-- | :-- |
| marker点击事件 | 点击marker弹出气泡，弹出气泡点击地图需要关闭气泡，由于marker点击事件会冒泡到点击地图事件，导致气泡直接被关闭 | 在PC端设备增加点击marker标识字段，控制忽略点击marker之后触发的点击地图事件 |
| marker label 点击事件 | 点击marker label的逻辑与点击marker逻辑一致，但是点击marker label不会触发点击地图事件 | 点击marker标识不能用于点击marker label的情况 |
| marker label 默认展示偏移差异 | 安卓默认标签显示非对中显示 | 针对安卓设备配置标签偏移展示 |
| 双指缩放触发区域变化事件 | PC端设备无法兼容到地图缩放引起的区域变化事件，会导致一些跟区域变化有关的交互无法正常处理，如关闭气泡/更新地图状态/计算气泡弹出位置 | 多监听鼠标滚轮事件，手动触发区域变更事件 |
| marker层级问题 | ⚠️PC端层级设置异常，绿色marker层级失效，无法覆盖普通marker | ⚠️无法处理 |
| 点击自定义聚合点 | ios下无法知道点击聚合点，导致无法对聚合点进行展开 | 监听地图点击事件，手动判断是否有点击到聚合点的定位位置，可能存在误差，同时数据量会消耗一些计算性能 |
| 点击默认聚合点 | ⚠️采用自定义聚合，忽略 | - |
| 聚合点变化事件 | 无法判断地图缩放到最大层级还有那些聚合点需要展开 | 无法解决，增加交互：允许到最大层级时，还存在聚合点，可以点击聚合点进行展开并45度角偏移展示 |

## 事件节流/防抖处理

- 区域变化事件：缩放/移动都会触发事件方式，节流处理事件
- 保存地图状态：区域变化/选点/撤销需要记录地图状态，防抖处理 + 状态比对处理（有变化才真正保存）
